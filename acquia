require "rubygems"
require "thor"
require "netrc"
require "highline/import"
require "faraday"
require "json"

class Acquia < Thor
  # A no_commands block is designed to show the methods that cannot be invoked
  # and as such, do not have a description.
  no_commands {
    # Internal: Used for outputting a pretty success message.
    #
    # Returns the coloured and formatted string.
    def success(text)
      puts "\e[#32m#{text}\e[0m"
    end

    # Internal: Used for outputting a pretty error message.
    #
    # Returns the coloured and formatted string.
    def fail(text)
      puts "\e[#31m#{text}\e[0m"
    end

    # Internal: Used for outputting a pretty info message.
    #
    # Returns the coloured and formatted string.
    def info(text)
      puts "\e[#36m#{text}\e[0m"
    end

    # Internal: Create a request to the Acquia API.
    #
    # The request generated contains all the correct user authentication and
    # headers.
    #
    # Returns a JSON string of the body.s
    def acquia_api_call(resource)
      n = Netrc.read
      @acquia_user, @acquia_password = n['cloudapi.acquia.com']

      conn = Faraday.new
      conn.basic_auth(@acquia_user, @acquia_password)
      response = conn.get "https://cloudapi.acquia.com/v1/#{resource}.json"
      response.body
    # Internal: Truncate a SSH key to a secure and recognisable size.
    #
    # Displaying whole SSH keys is probably a bad idea so instead we are getting
    # the first 30 characters and the last 100 characters of the key and
    # separating them with an ellipis. This allows you to recognise the
    # important parts of the key instead of the whole thing.
    #
    # Returns string.
    def truncate_ssh_key(ssh_key)
      front_part = ssh_key[0...30]
      back_part  = ssh_key[-50, 50]
      new_ssh_key = "#{front_part}...#{back_part}"
    end
  }

  # Public: Log into the Acquia Cloud API.
  #
  # This sets up the user account within the netrc file so that subsequent
  # calls can reuse the authentication without the user being prompted for it.
  desc 'login', 'Login to your Acquia account.'
  def login
    user = ask 'Enter your username:'
    password = ask 'Enter your password:'

    # Update (or create if needed) the netrc file that will contain the user
    # authentication details.
    n = Netrc.read
    n.new_item_prefix = "# This entry was added for connecting to the Acquia Cloud API\n"
    n['cloudapi.acquia.com'] = user, password
    n.save

    success 'Your user credentials have been successfully set.'
  desc "list-subscriptions", "Find all subscriptions that you have access to."
  def list_subscriptions
    subscriptions = JSON.parse(acquia_api_call("sites"))

    say "Available subscriptions:"
    subscription_count = 1
    subscriptions.each do |s|
      say "[#{subscription_count}] #{s}"
      subscription_count + 1
    end
  end

  desc 'subscriptions', 'Find all subscriptions that you have access to.'
  def subscriptions
    say acquia_api_call('sites')
  # Public: Provide an overview of the environments in your subscription.
  desc "view-environments <subscription>", "Provide an overview of the environments in your subscription."
  option :environment, :aliases => "-e"
  def view_environments(subscription)
    if options[:environment]
      subscriptions_details = JSON.parse(acquia_api_call("sites/#{subscription}/envs/#{options[:environment]}"))

      say "> Host: #{subscriptions_details["ssh_host"]}"
      say "> Environment: #{subscriptions_details["name"]}"
      say "> Current release: #{subscriptions_details["vcs_path"]}"
      say "> DB clusters: #{subscriptions_details["db_clusters"].to_s unless subscriptions_details["db_clusters"].nil?}"
      say "> Default domain: #{subscriptions_details["default_domain"]}"
      return
    end

    subscription_envs = JSON.parse(acquia_api_call("sites/#{subscription}/envs"))
    subscription_envs.each do |env|
      say "> Host: #{env["ssh_host"]}"
      say "> Environment: #{env["name"]}"
      say "> Current release: #{env["vcs_path"]}"
      say "> DB clusters: #{env["db_clusters"].to_s unless env["db_clusters"].nil?}"
      say "> Default domain: #{env["default_domain"]}"
      say
    end
  end

  # Public: Get server specs and information from the subscription.
  desc 'servers', 'Get a list of servers and specs associated with your subscription.'
  def servers
  # Public: Get server specs and information from the environment.
  desc "view-servers <subscription> <environment>", "Get a list of servers specifications for an environment."
  def view_servers(subscription, environment)
    server_env = JSON.parse(acquia_api_call("sites/#{subscription}/envs/#{environment}/servers"))
    server_env.each do |server|
      say "> Host: #{server["fqdn"]}"
      say "> EC2 region: #{server["ec2_region"]}"
      say "> Availability zone: #{server["ec2_availability_zone"]}"
      say "> EC2 instance type: #{server["ami_type"]}"

      if server["services"] && server["services"]["php_max_procs"]
        say "> PHP max processes: #{server["services"]["php_max_procs"]}"
      end

      if server["services"] && server["services"]["status"]
        say "> Status: #{server["services"]["status"]}"
      end

      if server["services"] && server["services"]["web"]
        say "> Environment status: #{server["services"]["web"]["env_status"]}"
      end
      say
    end
  end

  # Public: Get all databases in the subscription.
  desc 'databases', 'Get information on the database servers within your subscription.'
  def databases
    say 'getting databases'
  end

  # Public: Get all environment information.
  desc 'environments', 'See all available environments.'
  def environments
    say 'getting environments'
  end

  # Public: Get users on the subscription.
  desc 'users', 'Find out who has access and keys within your subscription.'
  def users
    say 'getting users'
  desc "view-users <subscription>", "Find out who has access and keys within your subscription."
  def view_users(subscription)
    users = JSON.parse(acquia_api_call("sites/#{subscription}/sshkeys"))

    say "Users"
    users.each do |user|
      say "> Name: #{user["nickname"]} (#{user["id"]})"
      say "> Key: #{truncate_ssh_key user["ssh_pub_key"]}"
      say
    end
  end
end

Acquia.start
